<!DOCTYPE html>
<html lang="pt-BR" data-theme="emerald">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    <title>AegisScan | Advanced Surface Auditor</title>

    <!-- Design Tokens & Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0',
                            500: '#10b981', 600: '#059669', 700: '#047857', 900: '#064e3b'
                        },
                        surface: '#ffffff',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --primary: #10b981;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }

        .emerald-gradient {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        }

        .scan-progress-ring {
            transition: stroke-dashoffset 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: screenEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes screenEnter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-active {
            color: var(--primary);
        }

        .nav-active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 20%;
            width: 60%;
            height: 4px;
            background: var(--primary);
            border-radius: 10px;
        }

        .btn-press:active {
            transform: scale(0.96);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>

<body class="pb-28">

    <!-- Global Header -->
    <header class="fixed top-0 left-0 right-0 z-50 px-6 py-6 glass-card rounded-none border-b border-emerald-50"
        role="banner">
        <div class="flex items-center justify-between max-w-lg mx-auto">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 emerald-gradient rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-shield-halved text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-extrabold tracking-tight leading-none">AEGIS SCAN</h1>
                    <span class="text-[9px] uppercase font-bold text-emerald-600 tracking-[0.2em]">Enterprise Surface
                        Auditor</span>
                </div>
            </div>
            <div id="connection-node"
                class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 border border-slate-200"
                aria-live="polite">
                <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <span class="text-[10px] font-bold text-slate-600 uppercase">System Ready</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-lg px-6 mt-32" role="main">

        <!-- DASHBOARD -->
        <section id="screen-dashboard" class="screen active" aria-labelledby="dash-title">
            <header class="mb-8">
                <h2 id="dash-title" class="text-3xl font-extrabold text-slate-900 mb-2">Discovery Hub</h2>
                <p class="text-slate-500 text-sm">Auditoria profunda de infraestrutura de rede.</p>
            </header>

            <!-- URL Input Module -->
            <div class="glass-card p-6 mb-8 border-2 border-emerald-50">
                <label for="target-url"
                    class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Target Application
                    URL</label>
                <div class="relative group">
                    <input type="url" id="target-url" placeholder="https://app-vulneravel.com"
                        class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all"
                        aria-required="true">
                    <button onclick="app.startAudit()"
                        class="absolute right-2 top-2 bottom-2 bg-emerald-500 text-white px-5 rounded-xl font-bold btn-press shadow-md hover:bg-emerald-600 transition-colors">
                        <i class="fas fa-bolt mr-2"></i> SCAN
                    </button>
                </div>
                <p class="mt-3 text-[10px] text-slate-400 font-medium">
                    <i class="fas fa-info-circle mr-1"></i> O Playwright ir√° interceptar XHR, Fetch e ativos de m√≠dia.
                </p>
            </div>

            <!-- Dashboard Stats -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="glass-card p-5 border-l-4 border-emerald-500">
                    <div class="text-emerald-500 mb-2"><i class="fas fa-radar text-lg"></i></div>
                    <div class="text-3xl font-black text-slate-800" id="stat-scans">0</div>
                    <div class="text-[10px] text-slate-400 font-bold uppercase">Auditorias</div>
                </div>
                <div class="glass-card p-5 border-l-4 border-blue-500">
                    <div class="text-blue-500 mb-2"><i class="fas fa-project-diagram text-lg"></i></div>
                    <div class="text-3xl font-black text-slate-800" id="stat-leaks">0</div>
                    <div class="text-[10px] text-slate-400 font-bold uppercase">Endpoints</div>
                </div>
            </div>

            <h3 class="font-bold text-slate-900 mb-4 flex items-center justify-between">
                <span>√öltimas Descobertas</span>
                <button onclick="app.showScreen('history')" class="text-emerald-600 text-[10px] font-bold uppercase">Ver
                    Todos</button>
            </h3>

            <div id="recent-audits" class="space-y-4">
                <div class="text-center py-12 glass-card border-dashed border-slate-200">
                    <p class="text-slate-400 text-sm">Pronto para iniciar a primeira an√°lise.</p>
                </div>
            </div>
        </section>

        <!-- SCANNING ANIMATION -->
        <section id="screen-scanning" class="screen">
            <div class="flex flex-col items-center justify-center min-h-[50vh]">
                <div class="relative w-56 h-56 mb-10">
                    <svg class="w-full h-full" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" stroke="#f1f5f9" stroke-width="10" fill="transparent"></circle>
                        <circle id="progress-circle" class="scan-progress-ring" cx="100" cy="100" r="90"
                            stroke="#10b981" stroke-width="10" stroke-dasharray="565.48" stroke-dashoffset="565.48"
                            stroke-linecap="round" fill="transparent"></circle>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="progress-percent" class="text-5xl font-black text-slate-800">0%</span>
                        <span
                            class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mt-1">Analyzing</span>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-slate-900 mb-2" id="scan-title">Injetando Playwright...</h3>
                <p id="status-text" class="text-slate-500 text-sm animate-pulse max-w-xs text-center">Mapeando
                    superf√≠cies de rede e protocolos de m√≠dia.</p>
            </div>
        </section>

        <!-- REPORT VIEW -->
        <section id="screen-report" class="screen">
            <div class="flex items-center justify-between mb-8">
                <button onclick="app.showScreen('dashboard')"
                    class="text-slate-500 font-bold text-xs flex items-center gap-2 btn-press">
                    <i class="fas fa-arrow-left"></i> VOLTAR AO HUB
                </button>
                <div class="flex gap-2">
                    <button onclick="app.toggleMediaPlayer()"
                        class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center shadow-sm btn-press">
                        <i class="fas fa-play-circle"></i>
                    </button>
                    <button onclick="app.shareReport()"
                        class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shadow-sm btn-press">
                        <i class="fas fa-share-nodes"></i>
                    </button>
                    <button onclick="app.exportJSON()"
                        class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center shadow-sm btn-press">
                        <i class="fas fa-code"></i>
                    </button>
                </div>
            </div>

            <!-- Media Player Modal -->
            <div id="media-player-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                <div class="glass-card max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="flex items-center justify-between p-6 border-b border-slate-100">
                        <h3 class="text-lg font-black text-slate-800">Media Streams Detected</h3>
                        <button onclick="app.toggleMediaPlayer()" class="text-slate-400 hover:text-slate-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="media-player-content" class="p-6">
                        <!-- Media content here -->
                    </div>
                </div>
            </div>

            <div id="report-content" class="space-y-6">
                <!-- Dynamically Generated -->
            </div>

            <!-- AI Chat Section (appears after report) -->
            <div id="ai-chat-section" class="hidden mt-8 pb-32">
                <div class="glass-card p-6 border-2 border-blue-500">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-blue-500 text-white flex items-center justify-center">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div>
                            <h3 class="text-sm font-black text-slate-800">Chat com Aegis AI</h3>
                            <p class="text-[10px] text-slate-500">Esclare√ßa d√∫vidas sobre o relat√≥rio</p>
                        </div>
                    </div>
                    
                    <div id="chat-messages" class="space-y-3 mb-4 max-h-96 overflow-y-auto custom-scroll">
                        <!-- Messages here -->
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Pergunte sobre vulnerabilidades, endpoints, etc..."
                            class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none"
                            onkeypress="if(event.key==='Enter') app.sendChatMessage()">
                        <button onclick="app.sendChatMessage()"
                            class="px-6 py-3 bg-blue-500 text-white rounded-xl font-bold btn-press shadow-md hover:bg-blue-600">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- HISTORY VIEW -->
        <section id="screen-history" class="screen">
            <header class="mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Vault</h2>
                <p class="text-slate-500 text-sm">Hist√≥rico completo de auditorias persistidas.</p>
            </header>
            <div id="vault-list" class="space-y-4 pb-20">
                <div class="text-center py-12 glass-card border-dashed border-slate-200">
                    <p class="text-slate-400 text-sm">Carregando vault...</p>
                </div>
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="screen-settings" class="screen">
            <header class="mb-8">
                <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Engine</h2>
                <p class="text-slate-500 text-sm">Configura√ß√µes do n√∫cleo de auditoria Aegis.</p>
            </header>
            <div class="space-y-6 pb-20">
                <div class="glass-card p-6">
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Worker Configuration
                    </h4>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-bold">Deep Interception</div>
                                <div class="text-[10px] text-slate-400">Capturar todos os pacotes XHR/Fetch</div>
                            </div>
                            <div class="w-12 h-6 bg-emerald-500 rounded-full relative shadow-inner">
                                <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-bold">Headless Mode</div>
                                <div class="text-[10px] text-slate-400">Rodar inst√¢ncias Chromium ocultas</div>
                            </div>
                            <div class="w-12 h-6 bg-emerald-500 rounded-full relative shadow-inner">
                                <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Gemini AI Configuration
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Preferred
                                Model</label>
                            <select id="ai-model-select" onchange="app.saveSettings()"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
                                <option value="models/gemini-3-flash-preview">Gemini 3 Flash Preview (Experimental)
                                </option>
                                <option value="models/gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (Ultra-Low Latency)
                                </option>
                                <option value="models/gemini-robotics-er-1.5-preview">Gemini Robotics ER 1.5</option>
                                <option value="models/gemini-2.0-flash" selected>Gemini 2.0 Flash</option>
                                <option value="models/gemini-1.5-flash">Gemini 1.5 Flash</option>
                                <option value="custom">Outro (ID Manual)</option>
                            </select>
                        </div>
                        <div id="custom-model-box" class="hidden">
                            <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Custom Model
                                ID</label>
                            <input type="text" id="ai-custom-model" onchange="app.saveSettings()"
                                placeholder="models/gemini-..."
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Google API
                            Key</label>
                        <input type="password" id="ai-api-key" onchange="app.saveSettings()"
                            placeholder="Paste your key here..."
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none">
                        <p class="text-[8px] text-slate-400 mt-1 font-bold">Your key is stored locally in your
                            browser.</p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6 border-l-4 border-red-500">
                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Danger Zone</h4>
                <button onclick="app.clearVault()"
                    class="w-full py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs btn-press">
                    <i class="fas fa-trash-can mr-2"></i> LIMPAR TODO O VAULT
                </button>
            </div>
            </div>
        </section>

    </main>

    <!-- Navigation Rail -->
    <nav class="fixed bottom-0 left-0 right-0 glass-card rounded-none border-t border-slate-100 px-8 py-4 z-50"
        role="navigation">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <button onclick="app.showScreen('dashboard')"
                class="relative flex flex-col items-center gap-1 nav-btn nav-active" data-screen="dashboard">
                <i class="fas fa-house-chimney text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Terminal</span>
            </button>
            <button onclick="app.showScreen('history')" class="relative flex flex-col items-center gap-1 nav-btn"
                data-screen="history">
                <i class="fas fa-database text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Vault</span>
            </button>
            <button onclick="app.showScreen('settings')" class="relative flex flex-col items-center gap-1 nav-btn"
                data-screen="settings">
                <i class="fas fa-gear text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Engine</span>
            </button>
        </div>
    </nav>

    <!-- Core Engine Logic -->
    <script type="module">
        class AegisApp {
            constructor() {
                this.db = null;
                this.activeAudit = null;
                this.apiBase = "http://localhost:8080/api/v1";
                this.settings = {
                    model: localStorage.getItem('aegis_model') || 'models/gemini-2.0-flash',
                    customModel: localStorage.getItem('aegis_custom_model') || '',
                    key: localStorage.getItem('aegis_key') || ''
                };
                this.init();
            }

            async init() {
                await this.initStorage();
                this.loadDashboardData();
                this.syncSettings();
                console.log("üõ°Ô∏è AegisScan Engine Online");
            }

            syncSettings() {
                const select = document.getElementById('ai-model-select');
                const customBox = document.getElementById('custom-model-box');
                const customInput = document.getElementById('ai-custom-model');

                if (select) {
                    // Check if value exists in options, if not use 'custom'
                    const options = Array.from(select.options).map(o => o.value);
                    if (options.includes(this.settings.model)) {
                        select.value = this.settings.model;
                    } else {
                        select.value = 'custom';
                        this.settings.customModel = this.settings.model;
                    }
                }

                if (customInput) customInput.value = this.settings.customModel;
                if (customBox) customBox.classList.toggle('hidden', select.value !== 'custom');

                const keyInput = document.getElementById('ai-api-key');
                if (keyInput) keyInput.value = this.settings.key;
            }

            saveSettings() {
                const select = document.getElementById('ai-model-select');
                const customBox = document.getElementById('custom-model-box');
                const customInput = document.getElementById('ai-custom-model');
                const keyInput = document.getElementById('ai-api-key');

                if (select) {
                    if (select.value === 'custom' && customInput) {
                        this.settings.model = customInput.value;
                        this.settings.customModel = customInput.value;
                        localStorage.setItem('aegis_custom_model', customInput.value);
                    } else {
                        this.settings.model = select.value;
                    }
                    localStorage.setItem('aegis_model', this.settings.model);
                    if (customBox) customBox.classList.toggle('hidden', select.value !== 'custom');
                }

                if (keyInput) {
                    this.settings.key = keyInput.value;
                    localStorage.setItem('aegis_key', keyInput.value);
                }
                this.notify(`Configura√ß√µes salvas.`);
            }

            async initStorage() {
                return new Promise((resolve) => {
                    const request = indexedDB.open("AegisVault", 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        db.createObjectStore("scans", { keyPath: "id", autoIncrement: true });
                    };
                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve();
                    };
                });
            }

            showScreen(name) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const target = document.getElementById('screen-' + name);
                if (target) target.classList.add('active');

                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.toggle('nav-active', b.dataset.screen === name);
                });

                if (name === 'history') this.loadVaultList();

                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async clearVault() {
                if (!confirm("Aten√ß√£o: Isso ir√° apagar todas as auditorias locais. Deseja continuar?")) return;
                const tx = this.db.transaction("scans", "readwrite");
                await tx.objectStore("scans").clear();
                this.notify("Vault limpo com sucesso.");
                this.loadDashboardData();
                this.showScreen('dashboard');
            }

            async loadVaultList() {
                const tx = this.db.transaction("scans", "readonly");
                const store = tx.objectStore("scans");
                const all = await new Promise(r => {
                    const req = store.getAll();
                    req.onsuccess = () => r(req.result);
                });

                const list = document.getElementById('vault-list');
                if (all.length === 0) {
                    list.innerHTML = `<div class="text-center py-20 opacity-40"><p>Nenhuma auditoria no vault.</p></div>`;
                    return;
                }

                list.innerHTML = all.reverse().map(s => `
                    <div class="glass-card p-5 flex items-center justify-between hover:border-emerald-300 transition-all cursor-pointer group" onclick="app.viewAudit(${s.id})">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-slate-100 text-slate-400 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-all">
                                <i class="fas fa-file-shield text-lg"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-black text-slate-800 truncate w-48">${s.target.replace(/^https?:\/\//, '')}</h4>
                                <div class="flex gap-2 mt-1">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${new Date(s.created_at || s.timestamp).toLocaleString()}</span>
                                    <span class="text-[9px] font-black text-emerald-500">${s.score}% Match</span>
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-xs text-slate-300 group-hover:text-emerald-500 transition-all"></i>
                    </div>
                `).join('');
            }

            async startAudit() {
                const urlInput = document.getElementById('target-url');
                const url = urlInput.value.trim();

                if (!url.match(/^https?:\/\/.+/)) {
                    this.notify("URL inv√°lida. Protocolo HTTP/HTTPS obrigat√≥rio.");
                    return;
                }

                this.showScreen('scanning');
                this.updateProgress(10, "Conectando ao Backend...");

                try {
                    const response = await fetch(`${this.apiBase}/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });

                    if (!response.ok) throw new Error("Erro na comunica√ß√£o com o backend.");

                    const result = await response.json();

                    // Emulation of progress steps
                    const steps = [
                        { p: 30, t: "Alocando Chromium Instanceless..." },
                        { p: 50, t: "Interceptando tr√°fego de rede..." },
                        { p: 75, t: "Extraindo manifestos e protocolos..." },
                        { p: 90, t: "Finalizando auditoria..." },
                        { p: 100, t: "Processamento conclu√≠do." }
                    ];

                    for (const step of steps) {
                        await new Promise(r => setTimeout(r, 600));
                        this.updateProgress(step.p, step.t);
                    }

                    // Pre-process endpoints and metadata if they come as strings
                    if (typeof result.endpoints === 'string') {
                        try { result.endpoints = JSON.parse(result.endpoints); } catch (e) { result.endpoints = []; }
                    }
                    if (typeof result.metadata === 'string') {
                        try {
                            const meta = JSON.parse(result.metadata);
                            result.media = meta.media;
                            result.schema = meta.schema;
                            result.tech = meta.tech;
                            result.seo = meta.seo;
                            result.assets = meta.assets;
                            result.full_links = meta.full_links;
                            result.performance = meta.performance;
                            result.discovery = meta.discovery;
                        } catch (e) { }
                    }

                    // Default structure if missing
                    result.media = result.media || { player: "Discovery Mode", streams: [], encryption: "N/A" };
                    result.schema = result.schema || ["Header", "Content", "Footer"];

                    await this.saveScan(result);
                    this.renderReport(result);
                    setTimeout(() => this.showScreen('report'), 500);

                } catch (err) {
                    this.notify("Falha cr√≠tica: " + err.message);
                    this.showScreen('dashboard');
                }
            }

            updateProgress(val, text) {
                const ring = document.getElementById('progress-circle');
                const percentLabel = document.getElementById('progress-percent');
                const statusLabel = document.getElementById('status-text');

                const circumference = 565.48;
                const offset = circumference - (val / 100) * circumference;

                if (ring) ring.style.strokeDashoffset = offset;
                if (percentLabel) percentLabel.innerText = `${val}%`;
                if (statusLabel) statusLabel.innerText = text;
            }

            async saveScan(data) {
                const tx = this.db.transaction("scans", "readwrite");
                await tx.objectStore("scans").add(data);
                this.loadDashboardData();
            }

            async loadDashboardData() {
                try {
                    const tx = this.db.transaction("scans", "readonly");
                    const store = tx.objectStore("scans");
                    const all = await new Promise(r => {
                        const req = store.getAll();
                        req.onsuccess = () => r(req.result);
                    });

                    document.getElementById('stat-scans').innerText = all.length;
                    document.getElementById('stat-leaks').innerText = all.reduce((acc, s) => {
                        const count = Array.isArray(s.endpoints) ? s.endpoints.length : 0;
                        return acc + count;
                    }, 0);

                    const recentList = document.getElementById('recent-audits');
                    if (all.length > 0) {
                        recentList.innerHTML = all.reverse().slice(0, 5).map(s => `
                            <div class="glass-card p-4 flex items-center justify-between hover:border-emerald-200 transition-all cursor-pointer group" onclick="app.viewAudit(${s.id})">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center group-hover:bg-emerald-500 group-hover:text-white transition-colors">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs font-black truncate w-40 text-slate-700">${s.target.replace(/^https?:\/\//, '')}</div>
                                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${new Date(s.created_at || s.timestamp).toLocaleDateString()}</div>
                                    </div>
                                </div>
                                <div class="text-emerald-500"><i class="fas fa-chevron-right text-xs"></i></div>
                            </div>
                        `).join('');
                    }
                } catch (e) { console.error(e); }
            }

            renderReport(data) {
                this.activeAudit = data;
                const container = document.getElementById('report-content');

                const copyBtn = (url) => `
                    <button onclick="app.copyToClipboard('${url}')" class="text-slate-400 hover:text-emerald-500 transition-colors ml-2" title="Copy Link">
                        <i class="fas fa-copy text-[10px]"></i>
                    </button>
                `;

                const generateAIReportBtn = `
                    <div id="ai-report-trigger" class="glass-card p-6 border-2 border-emerald-500 bg-emerald-50/50">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 rounded-2xl bg-emerald-500 text-white flex items-center justify-center shadow-lg animate-pulse">
                                <i class="fas fa-brain text-xl"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-black text-slate-800">An√°lise Inteligente Aegis AI</h4>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">Usando ${this.settings.model}</p>
                            </div>
                        </div>
                        <p class="text-[11px] text-slate-600 mb-4 font-medium">Gere um relat√≥rio t√©cnico masterizado com sugest√µes de arquitetura e mitiga√ß√£o de vulnerabilidades usando intelig√™ncia artificial.</p>
                        <button onclick="app.generateAIReport()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs btn-press shadow-xl flex items-center justify-center gap-2">
                             <i class="fas fa-sparkles"></i> GERAR RELAT√ìRIO MASTER
                        </button>
                    </div>
                `;

                container.innerHTML = `
                    <div class="glass-card p-6 emerald-gradient text-white">
                        <span class="text-[9px] font-black uppercase tracking-[0.2em] opacity-80">Enterprise Deep Auditor</span>
                        <h2 class="text-xl font-black truncate mb-4">${data.target}</h2>
                        <div class="flex gap-4">
                            <div class="bg-white/20 px-3 py-1 rounded-lg">
                                <span class="text-[10px] font-bold block opacity-60">Status</span>
                                <span class="text-xs font-black">COMPLETED</span>
                            </div>
                            <div class="bg-white/20 px-3 py-1 rounded-lg">
                                <span class="text-[10px] font-bold block opacity-60">Audit Score</span>
                                <span class="text-xs font-black">${data.score}%</span>
                            </div>
                        </div>
                    </div>

                    ${generateAIReportBtn}

                    <div id="ai-report-container" class="hidden space-y-4">
                        <div class="glass-card p-6 border-2 border-emerald-500 bg-white">
                             <div class="flex items-center justify-between mb-4 border-b border-emerald-50 pb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-robot text-emerald-500"></i>
                                    <span class="text-xs font-black uppercase tracking-widest text-slate-800">Master AI Review</span>
                                </div>
                                <span class="text-[9px] font-bold px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full">CONFIDENCIAL</span>
                             </div>
                             <div id="ai-report-body" class="prose prose-sm max-w-none text-slate-700 leading-relaxed text-[11px]">
                                <!-- AI Content Here -->
                             </div>
                        </div>
                    </div>

                    <div class="space-y-4 pb-12">
                        <!-- SEO & Metadata -->
                        <div class="glass-card p-6">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">SEO & Core Metadata</h4>
                            <div class="space-y-3">
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">Page Title</div>
                                    <div class="text-xs font-black text-slate-800">${data.seo?.title || 'No Title Found'}</div>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">Description</div>
                                    <p class="text-[11px] font-medium text-slate-600 line-clamp-2">${data.seo?.description || 'Missing meta description'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- API Mapping -->
                        <div class="glass-card p-6">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Endpoints & Network (XHR/Fetch)</h4>
                            <div class="space-y-2 max-h-64 overflow-y-auto custom-scroll pr-2">
                                ${Array.isArray(data.endpoints) && data.endpoints.length > 0 ? data.endpoints.map(e => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 group">
                                        <div class="flex items-center gap-2 overflow-hidden">
                                            <span class="text-[9px] font-black px-1.5 py-0.5 rounded ${e.status >= 400 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">${e.method || 'GET'}</span>
                                            <span class="text-[11px] font-bold font-mono text-slate-600 truncate">${e.url}</span>
                                            ${copyBtn(e.url)}
                                        </div>
                                        <span class="text-[9px] font-bold text-slate-400 flex-shrink-0">${e.status}</span>
                                    </div>
                                `).join('') : '<p class="text-[11px] text-slate-400 italic text-center py-4">No active API calls detected.</p>'}
                            </div>
                        </div>

                        <!-- Categorized Assets -->
                        <div class="glass-card p-6 border-l-4 border-blue-500">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Static Assets Discovery</h4>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-blue-50 rounded-xl">
                                    <div class="font-black text-blue-600 text-lg">${data.assets?.scripts?.length || 0}</div>
                                    <div class="text-[9px] font-bold text-blue-400 uppercase">JS Scripts</div>
                                </div>
                                <div class="p-3 bg-purple-50 rounded-xl">
                                    <div class="font-black text-purple-600 text-lg">${data.assets?.styles?.length || 0}</div>
                                    <div class="text-[9px] font-bold text-purple-400 uppercase">CSS Styles</div>
                                </div>
                            </div>
                            <div class="max-h-40 overflow-y-auto custom-scroll pr-2 space-y-1">
                                ${Array.isArray(data.full_links) ? data.full_links.map(l => `
                                    <div class="flex items-center text-[10px] font-bold text-slate-500 truncate group">
                                        <i class="fas fa-link mr-2 text-slate-300"></i>
                                        <span class="truncate">${l}</span>
                                        ${copyBtn(l)}
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>

                        <!-- Technical Vitals -->
                        <div class="glass-card p-6 bg-slate-50 border-dashed border-2 border-slate-200">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Security Headers</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">HSTS</span>
                                            <span class="font-black ${data.tech?.headers?.hsts !== 'Missing' ? 'text-emerald-500' : 'text-red-500'} text-[9px] truncate ml-2">${data.tech?.headers?.hsts || 'Missing'}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">X-Frame</span>
                                            <span class="font-black ${data.tech?.headers?.xFrame !== 'Missing' ? 'text-emerald-500' : 'text-red-500'} text-[9px] truncate ml-2">${data.tech?.headers?.xFrame || 'Missing'}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">Server</span>
                                            <span class="font-black text-slate-400 text-[9px] truncate ml-2">${data.tech?.headers?.server || 'Protected'}</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Health Check</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">HTTPS / SSL</span>
                                            <span class="font-black ${data.tech?.hasHttps ? 'text-emerald-500' : 'text-red-500'} text-[9px]">${data.tech?.hasHttps ? 'ACTIVE' : 'FAIL'}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">CSP Shield</span>
                                            <span class="font-black ${data.tech?.hasCsp ? 'text-emerald-500' : 'text-red-500'} text-[9px]">${data.tech?.hasCsp ? 'ACTIVE' : 'MISSING'}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-[11px]">
                                            <span class="text-slate-500">Cookies</span>
                                            <span class="font-black text-slate-800 text-[9px]">${data.tech?.cookies || 0} Registered</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Deep Discovery Section -->
                        <div class="glass-card p-6 border-l-4 border-amber-500">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Deep Discovery Hub</h4>
                            <div class="space-y-4">
                                <div>
                                    <div class="text-[9px] font-bold text-slate-400 uppercase mb-2">Tech Stack Detected</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${Array.isArray(data.tech?.techStack) && data.tech.techStack.length > 0 ?
                        data.tech.techStack.map(t => `<span class="px-2 py-1 bg-amber-50 text-amber-700 rounded-lg text-[10px] font-black border border-amber-100">${t}</span>`).join('') :
                        '<span class="text-[10px] text-slate-400 italic">No specific frameworks identified</span>'}
                                    </div>
                                </div>
                                <div class="p-4 bg-slate-900 rounded-2xl">
                                    <div class="text-[9px] font-black text-amber-500 uppercase tracking-widest mb-2 flex items-center justify-between">
                                        <span>Robots.txt Analysis</span>
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    <pre class="text-[9px] text-slate-300 font-mono overflow-x-auto custom-scroll max-h-32">${data.discovery?.robots || 'Scanning...'}</pre>
                                </div>
                            </div>
                        </div>

                         <!-- Performance Vitals -->
                        <div class="glass-card p-6">
                            <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Performance Vitals</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <div class="p-2 bg-slate-50 rounded-lg text-center">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">Load Time</div>
                                    <div class="text-xs font-black text-slate-800">${data.performance?.timing ? (data.performance.timing.loadEventEnd - data.performance.timing.navigationStart) + 'ms' : 'N/A'}</div>
                                </div>
                                <div class="p-2 bg-slate-50 rounded-lg text-center">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">DOM Ready</div>
                                    <div class="text-xs font-black text-slate-800">${data.performance?.timing ? (data.performance.timing.domContentLoadedEventEnd - data.performance.timing.navigationStart) + 'ms' : 'N/A'}</div>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-lg text-center">
                                    <div class="text-[9px] font-bold text-slate-400 uppercase">Heap Usage</div>
                                    <div class="text-xs font-black text-slate-800">${data.performance?.memory?.usedJSHeapSize ? Math.round(data.performance.memory.usedJSHeapSize / 1024 / 1024) + 'MB' : 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async generateAIReport() {
                const trigger = document.getElementById('ai-report-trigger');
                const container = document.getElementById('ai-report-container');
                const body = document.getElementById('ai-report-body');

                if (!this.activeAudit || !this.activeAudit.id) {
                    this.notify("Erro: ID de auditoria n√£o encontrado.");
                    return;
                }

                trigger.querySelector('button').disabled = true;
                trigger.querySelector('button').innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> PROCESSANDO RELAT√ìRIO...`;

                try {
                    const response = await fetch(`${this.apiBase}/ai/report`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scan_id: this.activeAudit.id,
                            model: this.settings.model,
                            api_key: this.settings.key
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || "Erro ao gerar relat√≥rio AI");
                    }

                    const report = await response.json();

                    trigger.classList.add('hidden');
                    container.classList.remove('hidden');

                    // Use marked.js to render markdown
                    body.innerHTML = marked.parse(report.content);

                    this.notify("Relat√≥rio Master AI gerado com sucesso!");
                    
                    // Show chat section after report is generated
                    document.getElementById('ai-chat-section').classList.remove('hidden');
                    
                    window.scrollTo({ top: body.offsetTop - 100, behavior: 'smooth' });

                } catch (err) {
                    this.notify("Falha: " + err.message);
                    trigger.querySelector('button').disabled = false;
                    trigger.querySelector('button').innerHTML = `<i class="fas fa-sparkles mr-2"></i> TENTAR NOVAMENTE`;
                }
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.notify("Link copiado para a √°rea de transfer√™ncia!");
                }).catch(err => {
                    this.notify("Falha ao copiar link.");
                });
            }

            async viewAudit(id) {
                const tx = this.db.transaction("scans", "readonly");
                const audit = await new Promise(r => {
                    const req = tx.objectStore("scans").get(id);
                    req.onsuccess = () => r(req.result);
                });
                if (audit) {
                    this.renderReport(audit);
                    this.showScreen('report');
                    
                    // Check if AI report exists for this scan
                    try {
                        const response = await fetch(`${this.apiBase}/ai/report/${audit.id}`);
                        if (response.ok) {
                            const report = await response.json();
                            const trigger = document.getElementById('ai-report-trigger');
                            const container = document.getElementById('ai-report-container');
                            const body = document.getElementById('ai-report-body');
                            
                            if (trigger && container && body) {
                                trigger.classList.add('hidden');
                                container.classList.remove('hidden');
                                body.innerHTML = marked.parse(report.content);
                                document.getElementById('ai-chat-section').classList.remove('hidden');
                            }
                        }
                    } catch (e) {
                        console.log('No AI report found for this scan');
                    }
                }
            }

            notify(msg) {
                const t = document.createElement('div');
                t.className = "fixed top-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-2xl text-xs font-bold z-[100] shadow-2xl animate-bounce";
                t.innerText = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            exportJSON() {
                if (!this.activeAudit) return;
                const blob = new Blob([JSON.stringify(this.activeAudit, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `aegis-scan-${Date.now()}.json`;
                a.click();
            }

            shareReport() {
                if (navigator.share) {
                    navigator.share({
                        title: 'AegisScan Report',
                        text: `Relat√≥rio de auditoria de ${this.activeAudit.target}`,
                        url: window.location.href
                    });
                } else {
                    this.notify("Compartilhamento n√£o suportado neste navegador.");
                }
            }

            async sendChatMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (!message || !this.activeAudit) return;

                const messagesContainer = document.getElementById('chat-messages');
                
                // Add user message
                this.addChatMessage('user', message);
                input.value = '';
                input.disabled = true;

                try {
                    const response = await fetch(`${this.apiBase}/ai/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scan_id: this.activeAudit.id,
                            message: message,
                            model: this.settings.model,
                            api_key: this.settings.key
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || "Erro ao enviar mensagem");
                    }

                    const data = await response.json();
                    this.addChatMessage('assistant', data.message);

                } catch (err) {
                    this.notify("Erro no chat: " + err.message);
                    this.addChatMessage('assistant', 'Desculpe, ocorreu um erro ao processar sua mensagem.');
                } finally {
                    input.disabled = false;
                    input.focus();
                }
            }

            addChatMessage(role, content) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                
                if (role === 'user') {
                    messageDiv.className = 'flex justify-end';
                    messageDiv.innerHTML = `
                        <div class="bg-blue-500 text-white px-4 py-3 rounded-2xl rounded-tr-sm max-w-[80%]">
                            <p class="text-xs font-medium">${content}</p>
                        </div>
                    `;
                } else {
                    messageDiv.className = 'flex justify-start';
                    messageDiv.innerHTML = `
                        <div class="bg-slate-100 text-slate-800 px-4 py-3 rounded-2xl rounded-tl-sm max-w-[80%]">
                            <div class="text-xs prose prose-sm">${marked.parse(content)}</div>
                        </div>
                    `;
                }
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            toggleMediaPlayer() {
                const modal = document.getElementById('media-player-modal');
                const content = document.getElementById('media-player-content');
                
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    this.renderMediaPlayer(content);
                } else {
                    modal.classList.add('hidden');
                }
            }

            renderMediaPlayer(container) {
                if (!this.activeAudit || !this.activeAudit.media) {
                    container.innerHTML = '<p class="text-slate-400 text-center py-8">Nenhuma m√≠dia detectada nesta auditoria.</p>';
                    return;
                }

                const media = this.activeAudit.media;
                const streams = media.streams || [];

                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="p-4 bg-purple-50 rounded-xl border border-purple-100">
                            <div class="text-xs font-bold text-purple-400 uppercase mb-2">Player Detectado</div>
                            <div class="text-sm font-black text-purple-700">${media.player || 'Unknown'}</div>
                        </div>

                        ${streams.length > 0 ? `
                            <div>
                                <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Streams Encontrados (${streams.length})</h4>
                                <div class="space-y-3">
                                    ${streams.map((stream, idx) => `
                                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-[10px] font-bold text-slate-400 uppercase">Stream ${idx + 1}</span>
                                                <span class="text-[9px] font-black px-2 py-1 rounded-full ${
                                                    stream.includes('.m3u8') ? 'bg-green-100 text-green-700' :
                                                    stream.includes('.mpd') ? 'bg-blue-100 text-blue-700' :
                                                    'bg-purple-100 text-purple-700'
                                                }">
                                                    ${stream.includes('.m3u8') ? 'HLS' : stream.includes('.mpd') ? 'DASH' : 'MP4'}
                                                </span>
                                            </div>
                                            <div class="text-[10px] font-mono text-slate-600 break-all mb-3">${stream}</div>
                                            ${stream.includes('.mp4') || stream.includes('.m3u8') ? `
                                                <video id="video-${idx}" controls class="w-full rounded-lg bg-black" style="max-height: 300px;">
                                                    ${!stream.includes('.m3u8') ? `<source src="${stream}" type="video/mp4">` : ''}
                                                    Seu navegador n√£o suporta reprodu√ß√£o de v√≠deo.
                                                </video>
                                                ${stream.includes('.m3u8') ? `
                                                    <script>
                                                        (function() {
                                                            const video = document.getElementById('video-${idx}');
                                                            if (Hls.isSupported()) {
                                                                const hls = new Hls();
                                                                hls.loadSource('${stream}');
                                                                hls.attachMedia(video);
                                                            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                                                video.src = '${stream}';
                                                            }
                                                        })();
                                                    </script>
                                                ` : ''}
                                            ` : `
                                                <a href="${stream}" target="_blank" class="block w-full py-2 bg-slate-900 text-white text-center rounded-lg text-xs font-bold btn-press">
                                                    <i class="fas fa-external-link-alt mr-2"></i>Abrir Stream
                                                </a>
                                            `}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : '<p class="text-slate-400 text-center py-8 text-sm">Nenhum stream de m√≠dia foi interceptado durante o scan.</p>'}
                    </div>
                `;
            }
        }

        window.app = new AegisApp();
    </script>
</body>

</html>